---
title: "Day 02: The Data Plane Gap (IAM vs. Linux Permissions)"
date: "2026-01-22"
tags: ["Linux", "Storage", "Security", "ACLs"]
difficulty: "Intermediate"
status: "Complete"
excerpt: "Cloud IAM stops people from attaching the disk, but it doesn't stop them from reading it. We break 'chmod 777' and fix it with ACLs."
---

## ðŸ‘‹ The Goal
We often assume that if we secure our Google Cloud IAM roles (e.g., only giving "Editor" access to specific people), our data is safe.

**This is a lie.**

Today, we explore the **Data Plane Gap**. Once a user is logged into a VM, Cloud IAM no longer applies. You are in the realm of Linux Permissions (`rwx`).
We will:
1.  Manually format and mount a raw disk.
2.  Simulate an "Insider Threat" scenario.
3.  Learn why `chmod 777` is deadly.
4.  Fix it using **Access Control Lists (ACLs)** and **Mount Options**.

*Prerequisites: A GCP Project and the VM from Day 01.*

---

## ðŸ—ï¸ Step 1: The Hardware (Adding a Vault)
First, we need a separate "safe" to store our secrets. We will attach a 10GB disk to our VM.

1.  **Create the Disk:**
    * Go to **Compute Engine** > **Disks**.
    * Click **Create Disk**.
    * Name: `vault-disk`.
    * Size: `10 GB`.
    * Region: Same as your VM (e.g., `us-central1-a`).
2.  **Attach it:**
    * Go to your VM (`manual-server-day1`).
    * Click **Edit**.
    * Scroll to "Additional disks" > **Attach existing disk**.
    * Select `vault-disk` and Save.

---

## ðŸ’¾ Step 2: The Plumbing (Format & Mount)
Linux doesn't automatically show new disks like Windows (D: drive). We have to build the road ourselves.

1.  **Find the Disk:**
    SSH into your VM and ask the kernel what it sees:
    ```bash
    lsblk
    ```
    *You should see `sdb` (Disk B) with 10G size.*

2.  **Format it (Draw the lines):**
    We need to create a filesystem so we can write files.
    ```bash
    sudo mkfs.ext4 -m 0 -E lazy_itable_init=0,lazy_journal_init=0,discard /dev/sdb
    ```
    *(Note: `-m 0` tells Linux not to reserve 5% of space for root. We want the whole disk.)*

3.  **Mount it (Hang the hook):**
    We create a directory and link the disk to it.
    ```bash
    sudo mkdir -p /mnt/vault
    sudo mount -o discard,defaults /dev/sdb /mnt/vault
    ```

4.  **Verify:**
    ```bash
    df -h /mnt/vault
    ```
    *Success: You should see "10G" available.*

---

## ðŸŽ­ Step 3: The Actors (Simulation)
We need to simulate a multi-user environment.
1.  **Create a Manager (The Victim):**
    ```bash
    sudo adduser manager
    ```
2.  **Create a Hacker (The Insider Threat):**
    ```bash
    sudo adduser hacker
    ```

---

## ðŸ’¥ Step 4: The "Breaker" (The 777 Trap)
Now, let's make the mistake that causes thousands of data breaches.

1.  **Switch to Manager:** `su - manager`
2.  **Create a Secret:**
    * First, the admin needs to give us permission to write to the vault folder:
        * (As Root): `chown manager:manager /mnt/vault`
    * (As Manager):
        ```bash
        echo "The nuclear launch code is 1234" > /mnt/vault/secret.txt
        ```
3.  **The Mistake:**
    The Manager wants a colleague to see the file, so they get lazy:
    ```bash
    chmod 777 /mnt/vault/secret.txt
    ```
    *`777` means: Everyone on this computer can Read, Write, and Execute this file.*

4.  **The Theft:**
    * Switch to Hacker: `su - hacker`
    * Steal the file:
        ```bash
        cat /mnt/vault/secret.txt
        ```
    * **Result:** **ACCESS GRANTED.** The data is compromised.

---

## ðŸ› ï¸ Step 5: The Fix (ACLs)


Standard permissions (Owner/Group/Others) are too blunt. What if we want to give `hacker` **Read-Only** access without making them the owner and without using 777?

**Enter ACLs (Access Control Lists).**

1.  **Lock it down:**
    (As Manager) Set permissions to `600` (Only Owner can read/write).
    ```bash
    chmod 600 /mnt/vault/secret.txt
    ```
    *Verify `hacker` gets "Permission Denied".*

2.  **Grant Surgical Access:**
    Use `setfacl` to add a specific rule for one user.
    ```bash
    setfacl -m u:hacker:r /mnt/vault/secret.txt
    ```
    *Translation: "Modify (`-m`) the ACL to give User (`u`) named 'hacker' Read (`r`) access."*

3.  **Verify:**
    (As Hacker): `cat /mnt/vault/secret.txt`
    *Result: Success!*
    (As Hacker): `echo "malware" >> /mnt/vault/secret.txt`
    *Result: Permission Denied!*

---

## ðŸ”’ Bonus: Hardening (The `noexec` Mount)
What if the hacker uploads a virus script to `/mnt/vault`?
Even if they can't overwrite our secret, they can use our disk to run malware.

1.  **The Attack:**
    (As Hacker): Create a script `virus.sh` and run it. It works.
2.  **The Defense:**
    We tell the Linux Kernel: "Never allow ANY program to run from this disk."
    ```bash
    sudo mount -o remount,noexec /mnt/vault
    ```
3.  **The Result:**
    The hacker tries to run `./virus.sh`.
    **Output:** `Permission denied` (Even if the file is executable!).

## ðŸ§  Key Takeaways
1.  **Cloud IAM â‰  OS Security:** IAM gets you to the door; Linux permissions protect the room.
2.  **Avoid 777:** It is never the solution. It is a surrender.
3.  **Use ACLs:** When you need granular access, use `setfacl` instead of opening the floodgates.
4.  **Mount Options:** Use `noexec` on data disks to neutralize malware drop zones.

### The Golden Commands
* `lsblk` (See physical disks)
* `getfacl <file>` (See hidden ACL permissions)
* `mount -o remount,noexec` (Lock down execution)
